# RH134 - Red Hat System Administration II
Several of the labs can be run from a local install of RHEL or CentOS.  This not only 
saves online lab time but allows greater flexibility in experimenting and getting
hands-on experience.

These instructions assume you have a base RHEL or CentOS system installed.  I
recommend using [VirtualBox](https://www.virtualbox.org/) to install 
an OS which can be saved or deleted as needed.

Be sure to create a shared folder with your VM so you can copy files between the
host and the VM.

Chapters:  
[Chapter 1. Improving Command-line Productivity](#chapter-1---improving-command-line-productivity)  
[Chapter 2.  Scheduling Future Tasks](#chapter-2---scheduling-future-tasks)  
[Chapter 3. Tuning System Performance](#chapter-3---tuning-system-performance)  
[Chapter 4. Controlling Access to Files with ACLs](#chapter-4---controlling-access-to-files-with-acls)  
[Chapter 5. Managing SELinux Security]()  
[Chapter 6. Managing Basic Storage]()  
[Chapter 7. Managing Logical Volumes]()  
[Chapter 8. Implementing Advanced Storage Features]()  
[Chapter 9. Accessing Network-Attached Storage]()  
[Chapter 10. Controlling the Boot Process]()  
[Chapter 11. Managing Network Security]()  
[Chapter 12. Installing Red Hat Enterprise Linux]()  
[Chapter 13. Comprehensive Review]()

## Chapter 1 - Improving Command-line Productivity
Bash shell scripts are files with sequences of commands.  First line should be:

```
#!/bin/bash
```

* 'Escaping' characters suppresses their special meaning.  Ie, `\#`, `\"`, etc
* Single quotes (`'xxx'`) preserve literal meaning of characters
* Double quotes (`"xxx"`) suppress globbing and shell expansion, allow command and variable substitution
* `echo text` - displays output
* `exit #` - exits script with exit code.  Use `$?` to access exit code
* Operators may be used to check for conditions.  See `man test` for list
* [ <expression> ] - test command, ie: `[1 -eq 1]; echo $?`
* [[ <expression> ]] - extended test, adds glob pattern and regex pattern matching
* Regular expressions: `man 7 regex`

For loop:

```
for <variable> in <list>; do
   <commands>
done
```

Examples:

```
for NUM in num1 num2 num3; do echo $NUM; done
for NUM in num{1..3}; do echo $NUM; done
for NUM in $(seq 2 2 10); do echo "$NUM"; done
```

If/then:

```
if <condition>; then
   <commands>
elif <condition>; then
   <commands>
else 
   <commands>   
fi
```

Regular expressions:

* `^` and `$` - anchors beginning and end of line
* `.` - wildcard matches any character
* `[xyz]` - matches x, y, or z
* `*` - matches zero or more of the previous expression
* `\{x\}` - matches previous expression x number of times
* Usually enclose in single quotes so shell doesn't interpret metacharacters
* `grep`, `sed`, `awk`, `vim`, `less`, etc - can use regex

Commands to know:
* `which <file>` - shows path and file which will be executed
* `grep` - searches for text pattern (regex).  `-i` - ignore case.  `-v` - lines not matching

### Labs
Labs can be run as documented.  
The section 4 lab has you ssh to different hosts.  To run the command as-is you may need a second VM.  
The section 6 lab assumes the `postfix` package was installed today.  To install the package: `yum -y install postfix`.  Start the postfix service: `systemctl start postfix`.

## Chapter 2 - Scheduling Future Tasks

Commands to know:

* `at <time>` - schedule command to run at certain time.  Takes input from STDIN, Ctrl+D to end.  Time may be given in several formats: `now +5min`, `noon +4 days`, `5pm august 3 2020`.  See `/usr/share/doc/at/timespec`
* `at -q <letter> <time>` - runs the job with priority `<letter>`.  a - highest, z - lowest
* `atq` - shows queued jobs
* `at -c #` - shows commands being executed for job #
* `atrm #` - removes job # from queue

* `crontab` - manages recurring jobs for user. `-r` - removes jobs.  `-l` - list jobs. `-e` - edit jobs
* crontab fields appear in the following order: `Minutes Hours Day_of_Month Month Day_of_Week Command`.  Syntax rules:
   * `*` - run always
   * For weekdays, 0 - Sunday, 1 - Monday . . .
   * `x-y` - sets range, inclusive
   * `x,y` - for lists.  Lists can include ranges
   * `*/x` - interval of `x`
   * Three-letter abbreviations for month and weekeday. `Mon`.  `Jan`

System-wide crontab defined in either `/etc/crontab` or files placed in `/etc/cron.d` directory.  Similar format to above except a user name is placed before the command.  
Scripts (not `crontab` files) may also be placed in the `/etc/cron.hourly`, `/etc/cron.daily`, `/etc/cron.weekly`, and `/etc/cron.monthly` directories.  These are run using the `/etc/cron.d/0hourly` (for hourly) and `/etc/anacrontab` (for all others).

Scheduling may also use `systemd` timer units.  Timer units may activate another unit time (like a service) when the unit name matches the timer unit name.  Modifications to the default profiles in `/usr/lib/systemd/system` should be placed in the `/etc/systemd/system` directory.  After a change run: `systemctl daemon-reload`, then `systemctl enable --now <unitname.timer>`.

Temporary files:

Creation and cleanup handled by `systemd-tmpfiles-clean.timer`.  View config file with: `systemctl cat systemd-tmpfiles-clean.timer`.

Manual cleanup is done using `systemd-tmpfiles --clean`.  See `man 5 tmpfiles.d` for details on the config file format.  Configuration files are:

* `/etc/tmpfiles.d/*.conf` - custom files go here
* `/run/tmpfiles.d/*.conf` - volitile
* `/usr/lib/tmpfiles.d/*.conf` - provided by system, do not edit

### Labs
Labs can be run as documented.

## Chapter 3 - Tuning System Performance

Commands to know:

* `tuned-adm active` - display active profile
* `tuned-adm list` - list profiles
* `tuned-adm profile <profile>` - switch to new profile
* `tuned-adm recommend` - show recommended profile
* `tuned-adm off` - turns off tuning

_Nice_ levels range from -20 (highest priority) to 19 (lowest priority).

* `top` - Nice values shown in `NI` column.  Sheduled priority shown in `PR` column
* `ps axo pid,comm,nice,cls --sort=-nice`
* `ps -o pid,comm,nice <pid_num>` - shows nice level for specified PID

* `nice <command>` - by default starts process with nice level of 10
* `nice -n xx <command>` - starts process with nice level of `xx`
* `renice -n xx <pid_num>` - changes nice level of PID
* `top` - renice process using `r` option

### Labs
Labs can be run as documented.  
Before starting the chapter 3 section 5 lab, start two processes:

```
md5sum /dev/zero &
sha1sum /dev/zero &
```

## Chapter 4 - Controlling Access to Files with ACLs

Commands to know:

* `ls -l` - shows `+` at end of permission string if ACLs set
* `getfacl fn` - display ACLs on fn

ACL mask defines maximum permissions for named users, group owner, and named groups.  Does not apply to file owner or other users.

* `setfacl -m u:name:rX file` - Modifies ACL for user `name`.  If `name` is blank applies to owner
* `setfacl -m g:group:rw file` - Modifies ACL for group `group`.  If `group` is blank applies to group owner
* `setfacl -m o::- file` - Modifies ACL for other users.  In this case, no permissions
* `getfacl fn | setfacl --set-file=- fn2` - Sets ACL on `fn2` to be the same as `fn1`
* `setfacl -m m::r file` - Sets ACL mask
* `setfacl -R -m u:name:rX dir` - Recursivly set ACL on directories
* `setfacl -x u:name,g:name file` - Removes ACL for specified user/group
* `setfacl -b file` - Removes all ACLs for file
* `setfacl -m d:u:name:rx dir` - Sets the default ACLs on a directory - used for inheritance

### Labs
Labs can be run as documented.

#### Section 4 Lab
For section 4 lab, create the users and groups (switch to root first):

```
for USER in sysadmin1 operator1 consultant1 consultant2;do adduser $USER;done
for USER in sysadmin1 operator1 consultant1 consultant2;do passwd $USER;done
groupadd operators
groupadd consultants
usermod -aG operators sysadmin1
usermod -aG consultants consultant1
usermod -aG consultants consultant2
mkdir -p /shares/content/server-info
chgrp -R operators /shares
chmod -R g+s /shares
```

Set up the sample files used in the lab.  First, create a script file called `/shares/content/loadavg.sh` with the following:

```
#!/bin/bash
echo '#################################################'
hostname
echo '#################################################'
date
echo '#################################################'
cat /proc/loadavg
echo '#################################################'
```

Then run the following commands:

```
chmod +x /shares/content/loadavg.sh
/shares/content/loadavg.sh > /shares/content/serverb-loadavg.txt
```

#### Section 5 Lab
Create the users and groups necessary.  As root:

```
for USER in manager{1..2} contractor{1..3};do adduser $USER;done
for USER in manager{1..2} contractor{1..3};do passwd $USER;done
groupadd managers
groupadd contractors
for USER in contractor{1..3};do usermod -aG contractors $USER;done
for USER in manager{1..2};do usermod -aG managers $USER;done
mkdir -p /shares/cases
touch /shares/cases/shortlist.txt
touch /shares/cases/backlog.txt
```

## Chapter 5 - Managing SELinux Security
